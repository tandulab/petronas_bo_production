import{a as ee}from"./api.esm40505.js";import{o as te,u as oe,c as R,af as ae,r as p,a as K,ag as se,b as d,l as ne,e as w,f as S,h as a,z as r,C as k,A as m,j as E,g as y,m as re,w as O}from"./usetoast.esm40505.js";import{u as le}from"./useconfirm.esm40505.js";import{u as ie}from"./country40505.js";import{e as T,a as ce,s as L,h as B}from"./helpers40505.js";import{u as Q}from"./survey40505.js";import{a as ue}from"./formatData40505.js";import{w as P}from"./runtime-dom.esm-bundler40505.js";import{_ as j}from"./_plugin-vue_export-helper40505.js";import"./utils.esm40505.js";import"./datetime40505.js";const de={setup(){te(()=>{g.value=!0,l.value={first:0,rows:D.value.rows,sortField:null,sortOrder:null,filters:b.value},ee.register("myfilter",(t,s)=>t===s),C()});const v=Q(),n=ie(),M=le(),o=oe(),U=R(()=>v.responseSurveys),A=R(()=>n.allCountries),x=R(()=>o.getSelectedCountry),c=R(()=>v.getReportSurvey),f=ae(),D=p(),h=p(!1),b=p({name:{value:"",matchMode:"contains"},active_from:{value:"",matchMode:"contains"},active_to:{value:"",matchMode:"contains"},company_name:{value:"",matchMode:"contains"},country:{value:"",matchMode:"contains"},status:{value:"",matchMode:"contains"}}),V=p(),g=p(!0),l=p(),F=p(0),e=p(),i=p([{label:"My Filter",value:"myfilter"}]),u=p([{label:"Active",value:"active"},{label:"Draft",value:"draft"},{label:"Expired",value:"expired"},{label:"Waiting",value:"waiting"}]);function C(){g.value=!0;const t=new Map;t.set("country_id",x.value.id),t.set("active_from",b.value.active_from.value),t.set("status",b.value.status.value),t.set("page",l.value.page+1),t.set("per_page",l.value.rows),l.value.sortField&&(l.value.sortOrder==1?t.set("sorted_by",l.value.sortField+"_asc"):t.set("sorted_by",l.value.sortField+"_desc")),setTimeout(()=>{z(t)},Math.random()*1e3+250)}const z=async function(t){await v.fetchAllSurveys(t).then(()=>{g.value=!1}).catch(s=>{g.value=!1,T(f,s)})},N=t=>{l.value=t,C()},I=t=>{l.value=t,C()},W=()=>{l.value.page=0,l.value.filters=b.value,C()},G=(t,s)=>{s.users_counter>0?M.require({target:t.currentTarget,message:"The survey cannot be deleted because there are associated users.",icon:"pi pi-exclamation-triangle",rejectClass:"hidden",acceptClass:"hidden"}):M.require({target:t.currentTarget,message:"Are you sure you want to remove this survey?",icon:"pi pi-exclamation-triangle",accept:()=>{H(s.id)}})},H=async function(t){await v.deleteSurvey(t).then(()=>{ce(f,{message:"Survey deleted correctly.",title:""}),C()}).catch(s=>{T(f,s)})},J=function(t){K.push({name:"survey-detail",params:{id:t.id}})},X=function(t){K.push({name:"survey-report",params:{id:t.id,typology:t.typology}})},Y=t=>{e.value=t,e.value.typology=="open"?q():(Z(t.id),h.value=!0)},Z=async function(t){L(),v.fetchSurveyReport(t).then(()=>{B(),V.value=$()}).catch(s=>{B(),T(f,s)})},$=()=>{const t=[],s=[];return c.value.answers.forEach(_=>{s.push(_.percentage),t.push(_.text.text)}),{chartData:{datasets:[{data:s,backgroundColor:["#cd1867","#DB4CB3","#EABB3D","#B958D8","#a1c653","#009265"]}],labels:t},chartOptions:{maintainAspectRatio:.5,plugins:{legend:{display:!1},tooltip:{callbacks:{label:_=>`${_.formattedValue}%`}}}}}},q=async function(){L();try{const s=await se({method:"get",url:`/surveys/${e.value.id}/download_answers`,responseType:"blob"});var t=new Blob([s.data],{type:s.headers["content-type"]});const _=document.createElement("a");_.href=window.URL.createObjectURL(t),_.download="report_survey.xlsx",_.click(),B()}catch(s){B(),T(f,s)}};return{dt:D,responseSurveys:U,filters:b,loading:g,totalRecords:F,lazyParams:l,matchModes:i,countries:A,survey_chart:V,selected_survey:e,surveyReport:c,visible:h,survey_status:u,loadLazyData:C,onPage:N,onSort:I,onFilter:W,toggleEdit:J,toggleReport:X,confirmDeleteSurvey:G,formatDataFromSql:ue,showTemplate:Y,downloadReport:q,getQuestion:function(){var s;const t=(s=e.value.country)==null?void 0:s.default_language_code;if(t)return e.value.translations[t].title.text}}}};const ve={key:0},pe=y("div",{class:"text-center"},"Results",-1),me={class:"text-center"},ye={style:{"min-width":"145px"}},fe={class:"col-12 flex"},_e={key:0,class:"col-8 px-0 mt-3"},he={class:"text-center font-semibold mb-2 mt-0"},be={class:"col-4 flex justify-content-end"},ge={key:1,class:"flex flex-column mt-3"},we={class:"mb-1"};function Se(v,n,M,o,U,A){const x=d("Calendar"),c=d("Column"),f=d("Badge"),D=d("Dropdown"),h=d("Button"),b=d("DataTable"),V=d("Chart"),g=d("Dialog"),l=d("ConfirmPopup"),F=ne("tooltip");return w(),S("div",null,[a(b,{value:o.responseSurveys.surveys,lazy:!0,paginator:!0,rows:30,filters:o.filters,"onUpdate:filters":n[0]||(n[0]=e=>o.filters=e),ref:"dt",dataKey:"id",loading:o.loading,totalRecords:o.responseSurveys.total,onPage:n[1]||(n[1]=e=>o.onPage(e)),onSort:n[2]||(n[2]=e=>o.onSort(e)),onFilter:n[3]||(n[3]=e=>o.onFilter()),filterDisplay:"row",removableSort:""},{empty:r(()=>[k(" No surveys found. ")]),default:r(()=>[a(c,{field:"active_from",header:"Active from",filterMatchMode:"contains",ref:"active_from",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:r(({data:e})=>[k(m(o.formatDataFromSql(e.active_from)),1)]),filter:r(({filterModel:e,filterCallback:i})=>[a(x,{inputId:"dateformat",modelValue:e.value,"onUpdate:modelValue":u=>e.value=u,dateFormat:"dd/mm/yy",onKeydown:P(u=>i(),["enter"]),manualInput:!1,placeholder:"Filter by data",onDateSelect:u=>i()},null,8,["modelValue","onUpdate:modelValue","onKeydown","onDateSelect"])]),_:1},512),a(c,{field:"active_to",header:"Active to",filterMatchMode:"contains",ref:"active_to",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:r(({data:e})=>[k(m(o.formatDataFromSql(e.active_to)),1)]),filter:r(({filterModel:e,filterCallback:i})=>[a(x,{inputId:"dateformat",modelValue:e.value,"onUpdate:modelValue":u=>e.value=u,dateFormat:"dd/mm/yy",onKeydown:P(u=>i(),["enter"]),manualInput:!1,placeholder:"Filter by data",onDateSelect:u=>i()},null,8,["modelValue","onUpdate:modelValue","onKeydown","onDateSelect"])]),_:1},512),a(c,{field:"hidden_at",header:"Visible until"},{body:r(({data:e})=>[k(m(o.formatDataFromSql(e.hidden_at)),1)]),_:1}),a(c,{field:"",header:"Question"},{body:r(({data:e})=>[e.translations[e.country.default_language_code]&&e.translations[e.country.default_language_code].description?(w(),S("span",ve,m(e.translations[e.country.default_language_code].description.text),1)):E("",!0)]),_:1}),a(c,{header:"",field:"total_results",style:{width:"6rem"}},{header:r(()=>[pe]),body:r(({data:e})=>[y("div",me,m(e.total_results),1)]),_:1}),a(c,{header:"Status",field:"status",filterMatchMode:"contains",ref:"status",sortable:!1,showFilterMatchModes:!1,showFilterOperator:!1,showFilterMenu:!1},{body:r(({data:e})=>[a(f,{value:e.status,class:re(["px-4 border-round-lg",e.status])},null,8,["value","class"])]),filter:r(({filterModel:e,filterCallback:i})=>[a(D,{modelValue:e.value,"onUpdate:modelValue":u=>e.value=u,options:o.survey_status,optionValue:"value",optionLabel:"label",onChange:u=>i(),placeholder:"Filter by status"},null,8,["modelValue","onUpdate:modelValue","options","onChange"])]),_:1},512),a(c,{header:""},{body:r(({data:e})=>[y("div",ye,[O(a(h,{type:"button",onClick:i=>o.toggleEdit(e),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-pencil",disabled:!e.can_edit},null,8,["onClick","disabled"]),[[F,"Edit",void 0,{top:!0}]]),O(a(h,{type:"button",onClick:i=>o.confirmDeleteSurvey(i,e),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-trash",disabled:!e.can_delete},null,8,["onClick","disabled"]),[[F,"Delete",void 0,{top:!0}]]),O(a(h,{type:"button",onClick:i=>o.showTemplate(e),"aria-haspopup":"true","aria-controls":"overlay_menu",class:"p-button-text p-button-rounded text-300 surface-200 mr-3",icon:"pi pi-chart-bar"},null,8,["onClick"]),[[F,"Report",void 0,{top:!0}]])])]),_:1})]),_:1},8,["value","filters","loading","totalRecords"]),a(g,{style:{width:"40vw"},visible:o.visible,"onUpdate:visible":n[5]||(n[5]=e=>o.visible=e),modal:"",header:"Survey report"},{default:r(()=>[y("div",fe,[o.selected_survey.typology=="closed"&&o.selected_survey.id&&o.surveyReport&&o.surveyReport.answers&&o.survey_chart?(w(),S("div",_e,[y("p",he,m(o.getQuestion())+" - Respondents: "+m(o.surveyReport.total),1),a(V,{type:"bar",data:o.survey_chart.chartData,options:o.survey_chart.chartOptions},null,8,["data","options"])])):E("",!0),y("div",be,[a(h,{class:"p-button-outlined p-button-secondary",label:"Report",icon:"pi pi-download",onClick:n[4]||(n[4]=e=>o.downloadReport())})]),o.selected_survey.typology=="open"&&o.surveyReport?(w(),S("div",ge,[y("span",we,"Question: "+m(o.getQuestion()),1),y("span",null,"Respondents: "+m(o.surveyReport.total||"-"),1)])):E("",!0)])]),_:1},8,["visible"]),a(l)])}const xe=j(de,[["render",Se]]),Ce={setup(){const v=Q();return{totalSurvey:R(()=>v.getTotalSurveys)}},components:{SurveysTable:xe}},De={class:"flex justify-content-between align-items-center"},Fe={class:"uppercase"},Re={key:0},Me={key:1};function Ve(v,n,M,o,U,A){const x=d("Button"),c=d("SurveysTable"),f=d("Card");return w(),S("div",null,[a(f,null,{content:r(()=>[y("div",De,[y("h1",Fe,[o.totalSurvey==1?(w(),S("span",Re," 1 Survey")):(w(),S("span",Me,m(o.totalSurvey)+" Surveys",1))]),a(x,{label:"survey",onClick:n[0]||(n[0]=D=>v.$router.push("/survey-detail")),icon:"pi pi-plus",class:"mb-3"})]),a(c)]),_:1})])}const je=j(Ce,[["render",Ve]]);export{je as default};
